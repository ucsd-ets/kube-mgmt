# values for local chart(opa-control)
vs:
  name: bundle-vs
  host: dsmlp.opa-dev.ucsd.edu
  path: /
  enabled: false

tls:
  name: bundle-tls
  crt: 
  key: 
  type: kubernetes.io/tls

#update ipPolicy with actual name/ip values
ipPolicy:
  enabled: false
  name: allow
  whitelist: 
  - "7.3.2.1/8"



# values shared by all charts
# mostly needed for opa_base and opa_addons to sync data
global:
  namespace: opa
  fullnameOverride: opa
  # Setup the webhook using cert-manager
  certManager:
    enabled: false
    rootCACertificateDuration: 43800h # 5y
    servingCertificateDuration: 8760h # 1y
  admissionController:
    enabled: false    
    # To set annotations on all admissionController resources (Secret/Certificate/Issuer/AdmissionController)
    # annotations:
    #   example: value

    # To _fail closed_ on failures, change to Fail. During initial testing, we
    # recommend leaving the failure policy as Ignore.
    failurePolicy: Ignore

    # Adds a namespace selector to the admission controller webhook
    namespaceSelector:
      matchExpressions:
        - {key: openpolicyagent.org/webhook, operator: NotIn, values: [ignore]}

    # SideEffectClass for the webhook, setting to NoneOnDryRun enables dry-run.
    # Only None and NoneOnDryRun are permitted for admissionregistration.k8s.io/v1.
    sideEffect: None

    # To restrict the kinds of operations and resources that are subject to OPA
    # policy checks, see the settings below. By default, all resources and
    # operations are subject to OPA policy checks.
    rules:
      - operations: ["CREATE", "UPDATE"]
        apiGroups: ["*"]
        apiVersions: ["*"]
        resources: ["*"]
        scope: "*"

  generateCerts: false
  #uses ca cert
  CA: 

# values for bundle chart
bundle:
  service:
    name: bundle-service
    protocol: TCP
    port: 5000
    targetPort: 80

  deployment:
    replicaCount: 1
    name: bundle-deployment
    image:
      repo: nginx
      version: 'latest'
    port: 80
    volume:
      app:
        name: bundle-mount
        mountPath: /usr/share/nginx/html/bundles
        nfs:
          server: its-dsmlpdev-fs01.ucsd.edu
          path: /export/apps/opa-bundles
  replicas: 1
  affinity: {}
  tolerations:
  # - key: node-type
  #   operator: Equal
  #   value: apps
  # - key: node-type
  #   operator: Equal
  #   value: spare
  topologySpreadConstraints:
  # - maxSkew: 1
  #   topologyKey: admin-zone
  #   whenUnsatisfiable: DoNotSchedule
  #   labelSelector:
  #     matchLabels:
  #       app: opa
  nodeSelector: {}

# values for opa_base chart
  # Default values for opa.
  # -----------------------
  #
  # The 'opa' key embeds an OPA configuration file. See https://www.openpolicyagent.org/docs/configuration.html for more details.
  # Use 'opa: false' to disable the OPA configuration and rely on configmaps for policy loading.
  # See https://www.openpolicyagent.org/docs/latest/kubernetes-admission-control/#3-deploy-opa-on-top-of-kubernetes and the `mgmt.configmapPolicies` section below for more details.
  
opa:
  opa:
    services:
      controller:
        url: 'http://bundle-service:5000'
    bundles:
      quickstart:
        service: controller
        resource: /bundles/bundle.tar.gz
        polling:
          min_delay_seconds: 25
          max_delay_seconds: 35
    default_decision: /system/main

    prometheus:
      enabled: true
    
    extraEnv: 
    - name: AWSED_API_KEY
      value: ""
    - name: AWSED_URL
      value: ""

    cert: 
    key:
#values for opa_addons chart
opa_addons:

  admissionControllers:
  - enabled: false    
    kind: MutatingWebhookConfiguration
    name: mutating-webhook.openpolicyagent.org
    nameA: mutate
  - enabled: false
    kind: ValidatingWebhookConfiguration
    name: validating-webhook.openpolicyagent.org
    nameA: validate
  configmapModifier:
    rules: 
    - apiGroups: [""]
      resources: ["configmaps"]
      verbs: ["update", "patch"]
    
    roleRef: 
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: configmap-modifier
    subjects: 
    - kind: Group
      name: system:serviceaccounts:opa
      apiGroup: rbac.authorization.k8s.io

  opaViewer:
    name: opa-viewer
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: view
    subjects: 
    - kind: Group
      name: system:serviceaccounts:opa
      apiGroup: rbac.authorization.k8s.io

      